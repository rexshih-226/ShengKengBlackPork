<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>晨光之芽・茶靈的最初祝福</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Noto Sans TC", sans-serif; overflow: hidden; }

        .task-container {
            width: 100vw;
            height: 100vh;
            background-image: url('任務一.png');
            background-size: cover;
            background-position: left center;
            position: relative;
        }

        .btn-back {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 200;
            transition: background 0.3s;
        }
        .btn-back:hover { background: rgba(0, 0, 0, 0.8); }

        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(880px, 90vw);
            padding: 32px 36px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 18px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.25);
            backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.6s ease, transform 0.6s ease;
            text-align: center;
        }
        .modal.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        .line { opacity: 0; transition: opacity 0.6s ease; text-align: center; color: #1f1b16; }
        .line.show { opacity: 1; }
        .title { font-size: 28px; font-weight: 800; letter-spacing: 1px; }
        .subtitle { font-size: 20px; margin-top: 8px; color: #4a3c2a; }

        .btn-continue {
            margin: 20px auto 10px;
            display: block;
            padding: 10px 22px;
            font-size: 16px;
            color: #fff;
            background: #3a7bf4;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.6s ease;
        }
        .btn-continue.show { opacity: 1; }
        .btn-continue.blink { animation: blink 1s infinite; }
        .btn-continue:disabled { cursor: not-allowed; opacity: 0.7; }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .story {
            margin: 10px auto 12px;
            line-height: 1.6;
            font-size: 16px;
            color: #2c241c;
            opacity: 0;
            transition: opacity 0.6s ease;
            text-align: center;
        }
        .story.show { opacity: 1; }

        .prompt {
            margin-top: 12px;
            font-size: 18px;
            font-weight: 700;
            color: #2f1f12;
            opacity: 0;
            transition: opacity 0.6s ease;
            text-align: center;
        }
        .prompt.show { opacity: 1; }

        .options {
            margin-top: 14px;
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .options.show { opacity: 1; }

        .option-btn {
            width: 140px;
            height: 140px;
            border: 3px solid transparent;
            border-radius: 12px;
            overflow: hidden;
            padding: 0;
            background: #fff;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        .option-btn:hover { transform: translateY(-2px); border-color: #3a7bf4; }
        .option-btn.correct { border-color: #2ecc71; }
        .option-btn.wrong { border-color: #e74c3c; }
        .option-btn img { width: 100%; height: 100%; object-fit: cover; }

        .result { margin-top: 12px; font-size: 16px; font-weight: 700; text-align: center; min-height: 22px; }
        .result.success { color: #2ecc71; }
        .result.error { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="task-container">
        <button class="btn-back" onclick="goBack()">← 返回</button>

        <div class="modal" id="modal">
            <div class="line title" id="lineTitle">任務 1：晨光之芽・茶靈的最初祝福</div>
            <div class="line subtitle" id="lineSubtitle">採茶菁</div>
            <button id="btnContinue" class="btn-continue">繼續</button>

            <div id="story" class="story"></div>
            <div id="prompt" class="prompt"></div>
            <div id="options" class="options"></div>
            <div id="result" class="result"></div>
        </div>
    </div>

    <script src="main.js"></script>
    <script>
        const sleep = (ms) => new Promise(res => setTimeout(res, ms));

        const modal = document.getElementById('modal');
        const lineTitle = document.getElementById('lineTitle');
        const lineSubtitle = document.getElementById('lineSubtitle');
        const btnContinue = document.getElementById('btnContinue');
        const story = document.getElementById('story');
        const promptEl = document.getElementById('prompt');
        const optionsEl = document.getElementById('options');
        const resultEl = document.getElementById('result');

        async function startSequence() {
            await sleep(1000); // 停一秒
            modal.classList.add('show');

            await sleep(300);
            lineTitle.classList.add('show');
            await sleep(500);
            lineSubtitle.classList.add('show');
            await sleep(600);
            btnContinue.classList.add('show', 'blink');
        }

        function getCouponStoreKey() {
            const user = (typeof getCurrentUser === 'function' && getCurrentUser()) || 'guest';
            return `coupons:${user}`;
        }

        function loadCouponsData() {
            const key = getCouponStoreKey();
            return JSON.parse(localStorage.getItem(key) || '{}');
        }

        function saveCouponsData(data) {
            const key = getCouponStoreKey();
            localStorage.setItem(key, JSON.stringify(data));
        }

        function awardCoupon() {
            const data = loadCouponsData();
            const now = Date.now();
            const thirtyDays = 30 * 24 * 60 * 60 * 1000;

            if (data['1']) {
                return { already: true };
            }

            data['1'] = {
                name: '茶葉產品75折優惠卷',
                obtainedAt: now,
                expiresAt: now + thirtyDays,
                used: false
            };

            saveCouponsData(data);
            return { already: false };
        }

        function renderOptions() {
            const choices = [
                { label: '一心一葉', img: '一心一葉.jpg', correct: false },
                { label: '一心二葉', img: '一心二葉.jpg', correct: true },
                { label: '一心三葉', img: '一心三葉.jpg', correct: false }
            ];

            optionsEl.innerHTML = '';

            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerHTML = `<img src="${choice.img}" alt="${choice.label}">`;
                btn.addEventListener('click', () => handleChoice(btn, choice.correct));
                optionsEl.appendChild(btn);
            });

            optionsEl.classList.add('show');
        }

        let answered = false;

        function handleChoice(btn, isCorrect) {
            if (answered) return;

            // 清除狀態
            document.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('correct', 'wrong');
            });

            if (isCorrect) {
                const res = awardCoupon();
                answered = true;
                btn.classList.add('correct');
                resultEl.className = 'result success';

                if (res.already) {
                    resultEl.textContent = '你已經領取過優惠卷';
                } else {
                    resultEl.textContent = '答對了';
                    setTimeout(() => {
                        resultEl.textContent = '你已成功獲得本關優惠券';
                    }, 800);
                }
            } else {
                btn.classList.add('wrong');
                resultEl.className = 'result error';
                resultEl.textContent = '答錯了';
            }
        }

        async function typeText(el, text, delay = 35) {
            el.innerHTML = '';
            for (let i = 0; i < text.length; i++) {
                const ch = text[i];
                el.innerHTML += (ch === '\n') ? '<br>' : ch;
                await sleep(delay);
            }
        }

        async function onContinue() {
            btnContinue.classList.remove('blink');
            btnContinue.disabled = true;
            story.classList.add('show');

            const text = `旭日初升，茶山沐浴在金光之中。此刻的每一片嫩芽被稱為「茶靈之芽」。\n唯有在正午前後採得最純淨的“一心二葉”，才能喚醒文山包種茶的第一道力量。`;
            await typeText(story, text, 35);

            await sleep(300);
            promptEl.textContent = '選出「一心二葉」';
            promptEl.classList.add('show');

            renderOptions();
        }

        function goBack() {
            window.location.href = 'game.html';
        }

        btnContinue.addEventListener('click', onContinue);
        startSequence();
    </script>
</body>
</html>
