<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>探秘深坑百年歷史</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Noto Sans TC", sans-serif; overflow: hidden; }
        .task-container { width: 100vw; height: 100vh; background-image: url('任務四.png'); background-size: cover; background-position: center; position: relative; }
        .btn-back { position: absolute; top: 20px; left: 20px; padding: 10px 15px; font-size: 16px; background: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 8px; cursor: pointer; z-index: 200; transition: background 0.3s; }
        .btn-back:hover { background: rgba(0, 0, 0, 0.8); }
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: min(880px, 90vw); max-height: 85vh; padding: 32px 36px; background: rgba(255, 255, 255, 0.85); border-radius: 18px; box-shadow: 0 12px 32px rgba(0,0,0,0.25); backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.6s ease; text-align: center; overflow-y: auto; }
        .modal.show { opacity: 1; }
        .line { opacity: 0; transition: opacity 0.6s ease; color: #1f1b16; }
        .line.show { opacity: 1; }
        .title { font-size: 28px; font-weight: 800; }
        .subtitle { font-size: 20px; margin-top: 8px; color: #4a3c2a; }
        .btn-continue { margin: 20px auto 10px; display: block; padding: 10px 22px; font-size: 16px; color: #fff; background: #3a7bf4; border: none; border-radius: 12px; cursor: pointer; opacity: 0; transition: opacity 0.6s ease; }
        .btn-continue.show { opacity: 1; }
        .btn-continue.blink { animation: blink 1s infinite; }
        .btn-continue:disabled { opacity: 0.7; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .story { margin: 10px auto 12px; line-height: 1.6; font-size: 16px; color: #2c241c; opacity: 0; transition: opacity 0.6s ease; }
        .story.show { opacity: 1; }
        .prompt { margin-top: 12px; font-size: 18px; font-weight: 700; color: #2f1f12; opacity: 0; transition: opacity 0.6s ease; }
        .prompt.show { opacity: 1; }
        .quiz { margin: 20px auto; opacity: 0; transition: opacity 0.4s ease; text-align: left; }
        .quiz.show { opacity: 1; }
        .question { margin-bottom: 20px; padding: 16px; background: rgba(255, 255, 255, 0.9); border-radius: 12px; }
        .question-title { font-size: 16px; font-weight: 700; color: #1f1b16; margin-bottom: 10px; }
        .options { display: flex; flex-direction: column; gap: 8px; }
        .option { padding: 10px; border: 2px solid #ccc; border-radius: 8px; cursor: pointer; transition: border 0.3s, background 0.3s; }
        .option:hover { background: rgba(58, 123, 244, 0.1); border-color: #3a7bf4; }
        .option.selected { border-color: #3a7bf4; background: rgba(58, 123, 244, 0.2); }
        .result { margin-top: 12px; font-size: 16px; font-weight: 700; min-height: 22px; }
        .result.success { color: #2ecc71; }
        .result.error { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="task-container">
        <button class="btn-back" onclick="goBack()">← 返回</button>
        <div class="modal" id="modal">
            <div class="line title" id="lineTitle">探秘深坑百年歷史</div>
            <div class="line subtitle" id="lineSubtitle">認識產茶歷史</div>
            <button id="btnContinue" class="btn-continue">繼續</button>
            <div id="story" class="story"></div>
            <div id="prompt" class="prompt"></div>
            <div id="quiz" class="quiz"></div>
            <div id="result" class="result"></div>
        </div>
    </div>
    <script src="main.js"></script>
    <script>
        const sleep = (ms) => new Promise(res => setTimeout(res, ms));
        const modal = document.getElementById('modal');
        const lineTitle = document.getElementById('lineTitle');
        const lineSubtitle = document.getElementById('lineSubtitle');
        const btnContinue = document.getElementById('btnContinue');
        const story = document.getElementById('story');
        const promptEl = document.getElementById('prompt');
        const quizEl = document.getElementById('quiz');
        const resultEl = document.getElementById('result');

        const question = {
            q: '某同學小論文探究臺灣某茶鄉的產業發展，採集到具有地方特色的閩南語「相褒歌」：「 透早（清晨）出門上茶山，冷風吹來會畏寒（感到寒冷）。親像（好比）孤鳥揣（找）無 伴，怎樣放我會孤單。」當地種茶事業的發達與 1860 年代「臺灣開港」有密切關係， 1860 至 1960 年代也是「相褒歌」最流行的期間。該小論文研究區域最可能位於下列何地？(113學測改)',
            opts: [
                'A. 新北市深坑區阿柔坑',
                'B. 新竹縣北埔鄉六份壢',
                'C. 南投縣竹山鎮杉林溪',
                'D. 嘉義縣阿里山鄉樂野'
            ],
            ans: 0
        };

        let selected = null;

        function validateAndShow(idx) {
            selected = idx;
            if (selected === question.ans) {
                const res = awardCoupon();
                resultEl.className = 'result success';
                if (res.already) {
                    resultEl.textContent = '你已經領取過優惠卷';
                } else {
                    resultEl.textContent = '答對了';
                    setTimeout(() => { resultEl.textContent = '你已成功獲得本關優惠券'; }, 1200);
                }
                // 鎖定所有選項
                setTimeout(() => {
                    Array.from(quizEl.querySelectorAll('.option')).forEach(el => el.style.pointerEvents = 'none');
                }, 100);
            } else {
                resultEl.className = 'result error';
                resultEl.textContent = '答錯了，請再試一次';
                // 允許重新選擇
                selected = null;
            }
        }

        async function startSequence() {
            await sleep(800);
            modal.classList.add('show');
            await sleep(300);
            lineTitle.classList.add('show');
            await sleep(400);
            lineSubtitle.classList.add('show');
            await sleep(500);
            btnContinue.classList.add('show', 'blink');
        }

        function getCouponStoreKey() {
            const user = (typeof getCurrentUser === 'function' && getCurrentUser()) || 'guest';
            return `coupons:${user}`;
        }

        function loadCouponsData() {
            return JSON.parse(localStorage.getItem(getCouponStoreKey()) || '{}');
        }

        function saveCouponsData(data) {
            localStorage.setItem(getCouponStoreKey(), JSON.stringify(data));
        }

        function awardCoupon() {
            const data = loadCouponsData();
            const now = Date.now();
            if (data['4']) return { already: true };
            data['4'] = {
                name: '深坑茶史導覽優惠券',
                obtainedAt: now,
                expiresAt: now + 30 * 24 * 60 * 60 * 1000,
                used: false
            };
            saveCouponsData(data);
            return { already: false };
        }

        function renderQuiz() {
            quizEl.innerHTML = '';
            const qDiv = document.createElement('div');
            qDiv.className = 'question';
            const qTitle = document.createElement('div');
            qTitle.className = 'question-title';
            qTitle.textContent = question.q;
            qDiv.appendChild(qTitle);
            const optsDiv = document.createElement('div');
            optsDiv.className = 'options';
            question.opts.forEach((opt, idx) => {
                const optDiv = document.createElement('div');
                optDiv.className = 'option';
                optDiv.textContent = opt;
                optDiv.addEventListener('click', () => {
                    Array.from(optsDiv.children).forEach(el => el.classList.remove('selected'));
                    optDiv.classList.add('selected');
                    validateAndShow(idx);
                });
                optsDiv.appendChild(optDiv);
            });
            qDiv.appendChild(optsDiv);
            quizEl.appendChild(qDiv);
        }

        async function typeText(el, text, delay = 35) {
            el.innerHTML = '';
            for (let i = 0; i < text.length; i++) {
                el.innerHTML += (text[i] === '\n') ? '<br>' : text[i];
                await sleep(delay);
            }
        }

        async function onContinue() {
            btnContinue.classList.remove('blink');
            btnContinue.disabled = true;
            story.classList.add('show');
            const text = `深坑茶鄉的山嵐曾飄過百年製茶的炊煙，\n1860 開港後的茶路，把這座山城推向國際。\n相褒歌在茶園間傳唱，記錄著採青的清晨與等待的孤鳥，\n也把產茶人家的韌性與溫度，綿延成一段段樸素的詩。`;
            await typeText(story, text, 35);
            await sleep(300);
            promptEl.textContent = '請選出最正確的答案';
            promptEl.classList.add('show');
            await sleep(300);
            renderQuiz();
            quizEl.classList.add('show');
        }

        function goBack() { window.location.href = 'game.html'; }
        btnContinue.addEventListener('click', onContinue);
        startSequence();
    </script>
</body>
</html>
