<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>止醱之炎・火淬茶魂（炒菁）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Noto Sans TC", sans-serif; overflow: hidden; }
        .task-container { width: 100vw; height: 100vh; background-image: url('任務三.png'); background-size: cover; background-position: center; position: relative; }
        .btn-back { position: absolute; top: 20px; left: 20px; padding: 10px 15px; font-size: 16px; background: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 8px; cursor: pointer; z-index: 200; transition: background 0.3s; }
        .btn-back:hover { background: rgba(0, 0, 0, 0.8); }
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: min(880px, 90vw); padding: 32px 36px; background: rgba(255, 255, 255, 0.8); border-radius: 18px; box-shadow: 0 12px 32px rgba(0,0,0,0.25); backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.6s ease; text-align: center; }
        .modal.show { opacity: 1; }
        .line { opacity: 0; transition: opacity 0.6s ease; color: #1f1b16; }
        .line.show { opacity: 1; }
        .title { font-size: 28px; font-weight: 800; }
        .subtitle { font-size: 20px; margin-top: 8px; color: #4a3c2a; }
        .btn-continue { margin: 20px auto 10px; display: block; padding: 10px 22px; font-size: 16px; color: #fff; background: #3a7bf4; border: none; border-radius: 12px; cursor: pointer; opacity: 0; transition: opacity 0.6s ease; }
        .btn-continue.show { opacity: 1; }
        .btn-continue.blink { animation: blink 1s infinite; }
        .btn-continue:disabled { opacity: 0.7; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .story { margin: 10px auto 12px; line-height: 1.6; font-size: 16px; color: #2c241c; opacity: 0; transition: opacity 0.6s ease; }
        .story.show { opacity: 1; }
        .prompt { margin-top: 12px; font-size: 18px; font-weight: 700; color: #2f1f12; opacity: 0; transition: opacity 0.6s ease; }
        .prompt.show { opacity: 1; }
        .game-area { margin: 20px auto; opacity: 0; transition: opacity 0.4s ease; }
        .game-area.show { opacity: 1; }
        .game-container { position: relative; width: 300px; height: 300px; margin: 0 auto; background: rgba(255, 255, 255, 0.9); border-radius: 12px; border: 3px solid #3a7bf4; }
        .btn-flip { padding: 16px 40px; font-size: 20px; font-weight: 700; color: #fff; background: #e74c3c; border: none; border-radius: 12px; cursor: pointer; opacity: 0; transition: opacity 0.3s; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .result { margin-top: 12px; font-size: 16px; font-weight: 700; min-height: 22px; }
        .result.success { color: #2ecc71; }
        .result.error { color: #e74c3c; }
        .result.progress { color: #3a7bf4; }
        .progress-text { margin-top: 12px; font-size: 14px; color: #7a6229; }
    </style>
</head>
<body>
    <div class="task-container">
        <button class="btn-back" onclick="goBack()">← 返回</button>
        <div class="modal" id="modal">
            <div class="line title" id="lineTitle">任務 3：止醱之炎・火淬茶魂（炒菁）</div>
            <div class="line subtitle" id="lineSubtitle">炒菁</div>
            <button id="btnContinue" class="btn-continue">繼續</button>
            <div id="story" class="story"></div>
            <div id="prompt" class="prompt"></div>
            <div id="gameArea" class="game-area">
                <div class="game-container">
                    <button id="btnFlip" class="btn-flip">翻動</button>
                </div>
            </div>
            <div id="result" class="result"></div>
            <div id="progressText" class="progress-text"></div>
        </div>
    </div>
    <script src="main.js"></script>
    <script>
        const sleep = (ms) => new Promise(res => setTimeout(res, ms));
        const modal = document.getElementById('modal');
        const lineTitle = document.getElementById('lineTitle');
        const lineSubtitle = document.getElementById('lineSubtitle');
        const btnContinue = document.getElementById('btnContinue');
        const story = document.getElementById('story');
        const promptEl = document.getElementById('prompt');
        const gameArea = document.getElementById('gameArea');
        const btnFlip = document.getElementById('btnFlip');
        const resultEl = document.getElementById('result');
        const progressText = document.getElementById('progressText');

        let successCount = 0;
        let isWaiting = false;

        async function startSequence() {
            await sleep(1000);
            modal.classList.add('show');
            await sleep(300);
            lineTitle.classList.add('show');
            await sleep(500);
            lineSubtitle.classList.add('show');
            await sleep(600);
            btnContinue.classList.add('show', 'blink');
        }

        function getCouponStoreKey() {
            const user = (typeof getCurrentUser === 'function' && getCurrentUser()) || 'guest';
            return `coupons:${user}`;
        }

        function loadCouponsData() {
            return JSON.parse(localStorage.getItem(getCouponStoreKey()) || '{}');
        }

        function saveCouponsData(data) {
            localStorage.setItem(getCouponStoreKey(), JSON.stringify(data));
        }

        function awardCoupon() {
            const data = loadCouponsData();
            const now = Date.now();
            if (data['3']) return { already: true };
            data['3'] = {
                name: '炒茶體驗課程優惠券',
                obtainedAt: now,
                expiresAt: now + 30 * 24 * 60 * 60 * 1000,
                used: false
            };
            saveCouponsData(data);
            return { already: false };
        }

        async function startGameRound() {
            if (isWaiting) return;
            isWaiting = true;
            
            // 隨機延遲 0-8秒出現按鈕
            const delay = Math.random() * 5000;
            btnFlip.style.opacity = '0';
            await sleep(delay);
            
            // 按鈕出現
            btnFlip.style.opacity = '1';
            const appearTime = Date.now();
            
            // 設置按鈕自動消失的計時器（0.8秒後消失）
            const disappearTimer = setTimeout(() => {
                if (btnFlip.style.opacity === '1') {
                    btnFlip.style.opacity = '0';
                    resultEl.className = 'result error';
                    resultEl.textContent = '火侯太多，炒菁失敗';
                    
                    // 1秒後清除錯誤信息並開始下一輪
                    setTimeout(() => {
                        resultEl.textContent = '';
                        isWaiting = false;
                        startGameRound();
                    }, 1000);
                }
            }, 800);
            
            // 按鈕點擊監聽（只執行一次）
            const handleClick = () => {
                btnFlip.removeEventListener('click', handleClick);
                clearTimeout(disappearTimer);
                
                if (btnFlip.style.opacity === '1') {
                    successCount++;
                    btnFlip.style.opacity = '0';
                    
                    resultEl.className = 'result progress';
                    resultEl.textContent = `完成第 ${successCount} 次炒菁`;
                    progressText.textContent = `已完成 ${successCount}/3`;
                    
                    if (successCount === 3) {
                        // 全部完成
                        setTimeout(async () => {
                            const res = awardCoupon();
                            resultEl.className = 'result success';
                            if (res.already) {
                                resultEl.textContent = '你已經領取過優惠卷';
                            } else {
                                resultEl.textContent = '答對了';
                                await sleep(800);
                                resultEl.textContent = '你已成功獲得本關優惠券';
                            }
                        }, 500);
                    } else {
                        // 繼續下一輪
                        setTimeout(() => {
                            resultEl.textContent = '';
                            progressText.textContent = '';
                            isWaiting = false;
                            startGameRound();
                        }, 1000);
                    }
                }
            };
            
            btnFlip.addEventListener('click', handleClick);
        }

        async function typeText(el, text, delay = 35) {
            el.innerHTML = '';
            for (let i = 0; i < text.length; i++) {
                el.innerHTML += (text[i] === '\n') ? '<br>' : text[i];
                await sleep(delay);
            }
        }

        async function onContinue() {
            btnContinue.classList.remove('blink');
            btnContinue.disabled = true;
            story.classList.add('show');
            const text = `當茶葉內部的醱酵達到極致，必須以高溫迅速制止。\n「止醱之炎」會中斷酵素活性，鎖住最完美的香氣，使茶魂免於失控。\n這是文山包種茶最關鍵的火煉儀式。`;
            await typeText(story, text, 35);
            await sleep(300);
            promptEl.textContent = '當「翻動」按鈕出現時，迅速點擊它，共需成功 3 次';
            promptEl.classList.add('show');
            await sleep(400);
            gameArea.classList.add('show');
            progressText.textContent = '已完成 0/3';
            startGameRound();
        }

        function goBack() { window.location.href = 'game.html'; }
        btnContinue.addEventListener('click', onContinue);
        startSequence();
    </script>
</body>
</html>
